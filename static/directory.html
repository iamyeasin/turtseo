{% load static %}
<!DOCTYPE html>
<html>

<nav class="navbar navbar-expand-lg bg-dark bg-primary sticky-top">
	<!-- <nav class="navbar navbar-dark bg-dark">  -->
	<div class="container">
		<div class="collapse navbar-collapse" id="navbarNavAltMarkup">
			<ul class="navbar-nav">
				<li {% if '/' == request.path %} class="nav-item active mr-3" {% else %} class="nav-item mr-3"
					{% endif %}>
					<a class="nav-link" href="{% url 'index' %}">Home</a>
				</li>

				<li {% if 'search' in request.path %} class="nav-item active mr-3" {% else %} class="nav-item mr-3"
					{% endif %}>
					<a class="nav-link" href="{% url 'search' %}">Search</a>
				</li>

				<li {% if 'directory' in request.path %} class="nav-item active mr-3" {% else %} class="nav-item mr-3"
					{% endif %}>
					<a class="nav-link" href="{% url 'directory' %}">Directory</a>
				</li>

				<li {% if 'admin' in request.path %} class="nav-item active mr-3" {% else %} class="nav-item mr-3"
					{% endif %}>
					<a class="nav-link" href="{% url 'admin:index' %}">Admin Login</a>
				</li>

			</ul>
		</div>
	</div>
</nav>

<head>
	<title>Segmentizations</title>
	<!-- CSS only -->
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"
		integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
		integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="{% static 'style.css' %}">

	<!-- JS, Popper.js, and jQuery -->

	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
		integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
		crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
		integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
		crossorigin="anonymous"></script>

</head>

<body>
	<div class="container">
		<h1>Turtseo Directories</h1>
	</div>
	<form method="POST" id="form">
		<!-- {% csrf_token %} -->
		<div class="container form-group">
			<div class="form-group row pt-5">
				<label for="" class="col-sm-2 col-form-label">Create New Directory </label>
				<div class="col-sm-6">
					<input type="text" class="form-control" id="dirname" value="" required placeholder="My Site">
				</div>
				<div class="form-group col-sm-4">
					<input type="submit" id="createdir" class="btn btn-primary" value="Create Directory">
				</div>
			</div>
		</div>
	</form>
	<hr>
	<form method="POST" id="form-2">
		<div class="container form-group">
			<div class="form-group row pt-5">
				<div class="col-sm-8">
					<input type="text" name="" placeholder="Search Directory" class="form-control" id="searchdir">
				</div>
				<div class="col-sm-2">
					<input id="search" type="submit" name="" value="Search" class="btn-primary form-control">
				</div>
			</div>
			<div class="row pt-3 pb-2  pl-3">
				<input type="submit" name="" value="Refresh" class="btn btn-warning" id="refresh">
			</div>
			<div class="row">
				<div class="col-sm-6 pt-3">
					<h4 id="setdir">Directory Name:</h4> <!-- use javascript inner.html  -->
					<h4>Linked: </h4>
					<ol>
						<div id="delete_list"></div>
					</ol>
				</div>
				<div class="col-sm-6 pt-5" id="add_list">
					<div class="row">
						<div class="col-sm-6">
							<input id="search_key_text" type="text" name="" class="form-control"
								placeholder="Search Guest link">
						</div>
						<div class="col-sm-3">
							<input id="search_key" type="submit" class="form-control btn btn-primary" value="search">
						</div>
					</div>
					<div class="row pt-5 pl-2">
						<!-- <div class="col-sm-6">
							<p>www.stickerdriver.com</p>
						</div>

						<div class="col-sm-6">
							<input type="submit" name="" id="addbtn_" value="Add Link" class="btn btn-light p-" >
						</div>
						<ol>
							<div id="add_list"></div>
							<li>Google.com <button style="margin-left: 50px;" type="button" class="btn btn-primary">ADD</button></li>
							<li>Google.com <button style="margin-left: 50px;" type="button" class="btn btn-primary">ADD</button></li>
						</ol>
					</div> -->
				</div>
			</div>
		</div>
	</form>

</body>
{% block script %}
<script src="{% static 'PapaParse/papaparse.min.js' %}"></script>
<script>

	$(document).ready(function (e) {

		// Initial Loading all Key Link in HTML

		var searchFoundDir = "";

		// Add link from guestpostlinkdir

		function addLinkToDirectoy( guestlink ){
			$.ajax({
				type: 'POST',
				url : '/directory',
				data: {
					'btnpressed': "addlinktodir",
					'url' : guestlink,
					'dirname' : searchFoundDir
				},
				success: function(data){
					alert("Link added to directory");
					$("#refresh").click()
				},
				error: function(data){
					alert("Link Adding failed")
				}

			});
		}


		// Initial Loads of all directory
		$.ajax({
			type: 'POST',
			url: '/directory',
			data: {
				'btnpressed': "initial"
			},
			success: function (data) {
				var dataset = JSON.parse(data['dataset']);
				console.log("ADD Data", dataset);

				// <b style="padding-left: 50px;"></b>

				for (var i = 0; i < dataset.length; i++) {
					// var str = "<li id=" + "addlink_" + i + ">" + dataset[i].pk + "<button style=" + '"margin-left: 50px;"' + " type=" + '"button"' + " class="
					// 	+ '"btn btn-primary"' + " id=" + "guestadd_" + i + ">ADD</button></li>";
					var addLink = '<hr><div class="row pt-2 pl-2" id="rowid_'+i+'">'
						+	'<div class="col-sm-6">'
						+ '<a id="addlink_'+ i +'" href="#"> '+ dataset[i].pk + '</a>'
						+  '</div>' 
						+ 	'<div class="col-sm-6">'
						+		'<input type="submit" name="" id="guestadd_'+ i +'" value="Add Link" class="btn btn-light p-">'
						+ 	'</div>'
						+ '</div>'
					$('#add_list').append(addLink);
				}

				// Send hits to background to a link 

				$("[id*='guestadd_']").click(function (e) {
						e.preventDefault();

						console.log("ABCD");
						var number = $(this).attr('id').split('_').pop(); //Geting the number for upload episode
						var src = $('#addlink_' + number).text();

						if (src == "") {
							alert("Couldn't grab the link");
							return false;
						}
						
						addLinkToDirectoy(src);


					});
			},
			error: function () {
				alert("Data Pai nai");
			}
		})

		// Create Directory
		$("#createdir").click(function (e) {
			e.preventDefault();

			if ($('#dirname').val() === "") {
				alert("Directory Name can't be Empty")
			}
			else {
				$.ajax({
					type: 'POST',
					url: '/directory',
					data: {
						'dirname': $('#dirname').val(),
						'btnpressed': "createdir"
					},
					success: function (e) {
						alert("Directory Created Successfully");
						$('#form')[0].reset();
					},
					error: function () {
						alert("Sorry, Directory isn't created");
					}
				});
			}
		});



		// generate related directory

		function delLinkToDirectoy( guestlink ){
			alert("Bainchod" + guestlink + " " + searchFoundDir)

				$.ajax({
					type: 'POST',
					url : '/directory',
					data: {
						'btnpressed': "delLinktodir",
						'url' : guestlink,
						'dirname' : searchFoundDir
					},
					success: function(data){
						alert("Link Deleted from directory");
						$("#refresh").click();

					},
					error: function(data){
						alert("Link Deleting Failed")
					}
				});
			}



		function genDirLink(){
			// document.getElementById("delete_list").innerHTML = "";

			$.ajax({
				type: 'POST',
				url: '/directory',
				data: {
					'searchdir': $('#searchdir').val(),
					'btnpressed': "search"
				},
				success: function (data) {
					var dataset = JSON.parse(data['dataset']);
					//console.log(dataset);
					searchFoundDir = $('#searchdir').val();

					$('#setdir').text("Directory Name: " + $('#searchdir').val())
					$("[id*='rowiddir_']").remove();

					for (var i = 0; i < dataset.length; i++) {
						// var str = "<li><div class=" + '"row pl-3"' + " id=" + '"linkedid_ '+i+'" '+"><p id=" + '"linkedp_"' + ">" + dataset[i].fields.key_link + "</p><a style="
						// 	+ '"padding-left: 50px;"' + " href=" + '"#"' + " id=" + '"linkeddel_"' + ">Delete Link</a>";
						var addLink = '<div class="row pt-2 pl-2" id="rowiddir_'+i+'">'
						+	'<div class="col-sm-6">'
						+  (i+1) + '. <a id="linkedid_'+ i +'" href="#"> '+ dataset[i].fields.key_link + '</a>'
						+  '</div>' 
						+ 	'<div class="col-sm-6">'
						+		'<input type="submit" name="" id="linkeddel_'+ i +'" value="Delete" class="btn btn-danger p-">'
						+ 	'</div>'
						+ '</div>'


						$('#delete_list').append(addLink);
					}

					$("[id*='linkeddel_']").click(function (e) {
						e.preventDefault();

						
						var number = $(this).attr('id').split('_').pop(); //Geting the number for upload episode
						var src = $('#linkedid_' + number).text();
						console.log(src);

						if (src == "") {
							alert("Couldn't grab the link");
							return false;
						}
						
						delLinkToDirectoy(src);
					});
				},
				error: function () {
					alert("Directory Not Found!");
				}
			})
		}

		$("#search").click(function (e) {
			e.preventDefault();
			genDirLink();
			
		})


		// Refresh Current Directory
		$("#refresh").click(function (e) {
			e.preventDefault();
			genDirLink();
			
		})
		

		// // Search Specific Key Link for Directory
		// function test2(){
		// 	document.getElementById("add_list").innerHTML = "";
		// 	alert($('#search_key_text').val(), "wss");

		// 	$.ajax({
		// 		type: 'POST',
		// 		url: '/directory',
		// 		data: {
		// 			'search_key_text': $('#search_key_text').val(),
		// 			'btnpressed': "search_key"
		// 		},
		// 		success: function (data) {
		// 			var dataset = JSON.parse(data['dataset']);
		// 			console.log("ADD Data", dataset);

		// 			for (var i = 0; i < dataset.length; i++) {
		// 				var str = "<li id=" + "addlink_" + i + ">" + dataset[i].pk + "<button style=" + '"margin-left: 50px;"' + " type=" + '"button"' + " class="
		// 					+ '"btn btn-primary"' + " id=" + "guestadd_" + i + ">ADD</button></li>";

		// 				$('#add_list').append(str);
		// 			}


		// 		},
		// 		error: function () {
		// 			alert("Data Pai nai");
		// 		}
		// 	})
		// }


		// $("#search_key").click(function (e) {
		// 	e.preventDefault();
		// 	var data = $('#search_key_text')[0].value
		// 	alert('fucking data', data )
		// 	test2();
		// })


		function sendHit( query ){
			console.log( query )
			$.ajax({
				type: 'POST',
				url: '/directory',
				data: {
					'search' : query+"",
					'btnpressed' : "search_key"
				},
				success: function(data){
					console.log("success " , query)
				},
				error: function(data){
					console.log("yo wrong", query)
				}

			})
		}


		$('#search_key_text').on("input", function(){
			var query = $("#search_key_text").val();

			if( query ){
				sendHit(query);	
			}

		});

		


	});

</script>
{% endblock %}

</html>